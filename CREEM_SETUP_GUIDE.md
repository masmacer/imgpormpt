# Creem 支付集成操作指南

## 🎉 已完成的配置

✅ **价格页面已恢复** - 用户现在可以访问 `/pricing` 页面
✅ **产品配置已创建** - 支持次数卡($9.90)和月订阅($19.90)
✅ **购买流程已实现** - 支持不同产品类型的购买
✅ **Webhook 处理已配置** - 自动处理支付成功回调
✅ **数据库脚本已准备** - 积分管理表结构

## 🔧 接下来你需要做的操作

### 1. 获取 Creem 产品/价格 ID
从 Creem 后台获取你创建的两个产品的具体 ID：
- **次数卡产品**: 产品ID 和 价格ID
- **月订阅产品**: 产品ID 和 价格ID

### 2. 配置环境变量
在你的 `.env.local` 文件中添加以下配置：

```bash
# Creem 基础配置
NEXT_PUBLIC_CREEM_PUBLIC_KEY="你的公钥"
CREEM_SECRET_KEY="你的私钥"
CREEM_WEBHOOK_SECRET="你的Webhook密钥"
NEXT_PUBLIC_CREEM_ENVIRONMENT="sandbox"  # 测试环境，上线后改为 "production"

# Creem 产品配置（替换为你在 Creem 后台看到的实际 ID）
CREEM_CREDITS_PRODUCT_ID="你的次数卡产品ID"
CREEM_CREDITS_PRICE_ID="你的次数卡价格ID"
CREEM_SUBSCRIPTION_PRODUCT_ID="你的月订阅产品ID" 
CREEM_SUBSCRIPTION_PRICE_ID="你的月订阅价格ID"
```

### 3. 执行数据库迁移
运行以下 SQL 脚本初始化数据库：

```bash
# 1. 先执行表结构迁移
# 在你的数据库工具中运行：database-migration-credits.sql

# 2. 然后插入基础积分计划数据
# 运行：database-init-credit-plans.sql
```

### 4. 配置 Creem Webhook
在 Creem 后台设置 Webhook 地址：
```
https://你的域名.com/api/payments/creem/webhook
```

### 5. 测试流程
1. **前端测试**: 访问 `/pricing` 页面，点击购买按钮
2. **支付测试**: 使用 Creem 测试卡号完成支付
3. **回调测试**: 确认支付成功后积分自动到账
4. **功能测试**: 使用图片转提示功能，确认积分正确扣减

## 📋 系统功能说明

### 次数卡 ($9.90)
- 一次性购买获得 100 积分
- 积分永不过期
- 每次生成提示词消耗 1 积分

### 月订阅 ($19.90/月)
- 每月获得 10,000 积分（相当于无限制）
- 自动续费
- 享受专业版功能

### 免费版
- 每日 10 次生成限制
- 每月最多 300 次
- 基础功能

## 🔄 积分管理机制

- **自动发放**: 支付成功后自动添加积分
- **自动扣减**: 使用功能时自动扣减积分
- **历史记录**: 完整的积分使用和充值记录
- **余额显示**: 实时显示用户积分余额和使用情况

## 🚨 注意事项

1. **测试环境**: 确保先在 sandbox 环境测试完整流程
2. **Webhook 安全**: 验证 Webhook 签名确保安全性
3. **错误处理**: 支付失败时需要合理提示用户
4. **数据备份**: 上线前备份数据库
5. **监控日志**: 关注支付和积分相关的日志

## 📞 需要帮助？

如果在配置过程中遇到问题：
- 检查环境变量是否正确配置
- 确认 Creem 产品 ID 是否正确
- 查看服务器日志了解错误详情
- 测试 Webhook 是否能正常接收回调

配置完成后，你的积分控制系统就可以正式运行了！🎊